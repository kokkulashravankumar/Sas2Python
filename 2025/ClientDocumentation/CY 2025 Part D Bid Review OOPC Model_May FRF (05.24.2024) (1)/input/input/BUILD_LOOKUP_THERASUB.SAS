* PROGRAM: BUILD_LOOKUP_THERASUB.SAS;

DATA FORM_RXCUI;
  SET FORMULARY_TIERS (WHERE=(TIER_LEVEL ^= '9'));
  LENGTH TAG_ID $3;
  TAG_ID=PUT(RXCUI,TAGFMT.);
  RANK=INPUT(PUT(RXCUI,RANKFMT.),5.);
RUN;
  
PROC SORT DATA=FORM_RXCUI;
  BY FORMULARY_ID TAG_ID RANK;
RUN;

DATA FORM_RXCUI_SUB;
  SET FORM_RXCUI;
  BY FORMULARY_ID TAG_ID;
  IF FIRST.TAG_ID;
RUN;

DATA FMT;
  SET FORM_RXCUI_SUB END=LAST;
  LENGTH START $11 FMTNAME $8 HLO LABEL $1;
  START=FORMULARY_ID || TAG_ID;
  LABEL=TIER_LEVEL;
  FMTNAME='$FGTFMT';
  HLO=' ';
  OUTPUT FMT;
  IF LAST THEN DO;
    START='OTHER';
    LABEL='9';
    HLO='O';
    OUTPUT FMT;
  END;
  KEEP START LABEL FMTNAME HLO;
RUN;

PROC FORMAT CNTLIN = FMT LIBRARY = LIBRARY;
RUN;  

DATA FMT;
  SET FORM_RXCUI_SUB END=LAST;
  LENGTH START $11 FMTNAME $8 HLO $1;
  START=FORMULARY_ID || TAG_ID;
  LABEL=AVG_PRICE;
  FMTNAME='$FTAGFMT';
  HLO=' ';
  OUTPUT FMT;
  IF LAST THEN DO;
    START='OTHER';
    LABEL=.;
    HLO='O';
    OUTPUT FMT;
  END;
  KEEP START LABEL FMTNAME HLO;
RUN;

PROC FORMAT CNTLIN = FMT LIBRARY = LIBRARY;
RUN;  

DATA FMT;
  SET FORM_RXCUI_SUB END=LAST;
  LENGTH START $11 FMTNAME $8 HLO $1;
  START=FORMULARY_ID || TAG_ID;
  LABEL=RXCUI;
  FMTNAME='$FRXCFMT';
  HLO=' ';
  OUTPUT FMT;
  IF LAST THEN DO;
    START='OTHER';
    LABEL=.;
    HLO='O';
    OUTPUT FMT;
  END;
  KEEP START LABEL FMTNAME HLO;
RUN;

PROC FORMAT CNTLIN = FMT LIBRARY = LIBRARY;
RUN;  